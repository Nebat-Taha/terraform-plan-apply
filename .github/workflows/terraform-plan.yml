name: Multi-Region Terraform Deployment

on:
  workflow_dispatch:
  # push:
  #   branches: [ main ]
  #   paths: ['terraform/regions/**', 'terraform/modules/**']

permissions:
  contents: read
  id-token: write

jobs:
  # --- JOB 1: PLAN ---
  terraform_plan:
    name: "Plan: ${{ matrix.region }}"
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false # Don't cancel other regions if one fails
      matrix:
        region: [us-east-1]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.12.1

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v3
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ matrix.region }}

      - name: Terraform Init
        run: terraform init -reconfigure
        working-directory: ./terraform/regions/${{ matrix.region }}

      - name: Terraform Plan
        # We save the plan to a file called 'tfplan'
        run: terraform plan -input=false -out=tfplan
        working-directory: ./terraform/regions/${{ matrix.region }}

      - name: Create Human Readable Plan
        run: terraform show -no-color tfplan > plan_readable.txt
        working-directory: ./terraform/regions/${{ matrix.region }}

      - name: Prepare Artifacts
        run: |
          mkdir -p staging
          cp terraform/regions/${{ matrix.region }}/tfplan staging/
          cp terraform/regions/${{ matrix.region }}/plan_readable.txt staging/

      - name: Upload Plan Artifact
        # We give it a unique name so regions don't overwrite each other
        uses: actions/upload-artifact@v4
        with:
          name: tfplan-${{ matrix.region }}
          path: terraform/regions/${{ matrix.region }}/tfplan

  # --- JOB 2: APPLY ---
  terraform_apply:
    name: "Apply: ${{ matrix.region }}"
    needs: terraform_plan
    runs-on: ubuntu-latest
    environment: production # <--- THIS IS THE HUMAN GATE
    strategy:
      matrix:
        region: [us-east-1, ap-southeast-2, eu-central-1]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v3
        with:
          aws-region: ${{ matrix.region }}
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

      - name: Download Plan Artifact
        uses: actions/download-artifact@v4
        with:
          name: tfplan-${{ matrix.region }}
          path: terraform/regions/${{ matrix.region }}/

      - name: Terraform Init
        run: terraform init -reconfigure
        working-directory: ./terraform/regions/${{ matrix.region }}

      - name: Terraform Apply
        # Apply using the EXACT plan file we generated in Job 1
        run: terraform apply -auto-approve tfplan
        working-directory: ./terraform/regions/${{ matrix.region }}
